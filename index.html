<!DOCTYPE html>
<html>
<head>
    <title>m3u 播放器</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        video,audio {
            width: 80%;
            height: auto;
        }
    </style>
</head>
<body>
    <div id="playerContainer"></div>

    <script>
        const playerContainer = document.getElementById('playerContainer');
        const urlParams = new URLSearchParams(window.location.search);
        let m3uUrl = urlParams.get('url');
        if(!m3uUrl){
            m3uUrl = "https://raw.githubusercontent.com/dxs1256/IPTV/refs/heads/main/live.m3u"
        }

        if (m3uUrl) {
           fetch(m3uUrl)
            .then(response => {
                 if (!response.ok) {
                   throw new Error(`Failed to fetch m3u file: ${response.status} ${response.statusText}`);
                 }
               return response.text()
             })
            .then(m3uContent => {
               const urls = m3uContent.split('\n')
                    .filter(line => !line.startsWith('#') && line.trim() !== '');

              let html = "";
              for(let url of urls) {
                  if(url.endsWith(".m3u8")) { // 使用 Hls.js 播放
                      html += `<video id="videoPlayer${urls.indexOf(url)}" controls></video><br/>`;
                  } else if(url.endsWith(".mp4")) {
                       html += `<video src="${url}" controls></video><br/>`;
                  } else if (url.endsWith(".mp3")) {
                      html += `<audio src="${url}" controls></audio><br/>`
                  } else {
                     html += `<p>无法播放: ${url}</p><br/>`
                  }
               }
             playerContainer.innerHTML = html;

            urls.forEach( (url, index) => {
                if(url.endsWith(".m3u8")) {
                    const video = document.getElementById(`videoPlayer${index}`);
                     if (Hls.isSupported()) {
                        const hls = new Hls();
                        hls.loadSource(url);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, function() {
                            video.play();
                        });
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = url;
                        video.addEventListener('loadedmetadata', function() {
                            video.play();
                        });
                    }
                 }
              })
        })
        .catch(error => {
             playerContainer.innerHTML = `<p>Error: ${error.message}</p>`;
         });
        } else {
            playerContainer.innerHTML = "<p>请提供 m3u 文件链接</p>";
        }

    </script>
</body>
</html>
